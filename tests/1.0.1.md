# Bitrix24 Plugin v1.0.1 Test Cases

> **Version:** 1.0.1  
> **Focus:** Attachment support, typing indicators, command visibility  
> **Created:** 2026-02-05

---

## Overview

This document outlines test cases for validating the Bitrix24 plugin v1.0.1 features. Each test includes:
- **Test ID** - Unique identifier for tracking
- **Description** - What is being tested
- **Why** - Rationale for this test case
- **Prerequisites** - Setup requirements
- **Steps** - Execution steps
- **Expected Result** - Success criteria
- **Priority** - Critical/High/Medium

---

## Test Suite: Incoming Attachments

### TC-001: Receive Image Attachment (Webhook → Agent)
**Priority:** Critical

**Description:**
Verify that when a user sends an image to the bot via Bitrix24, the webhook properly parses the attachment metadata and passes it to the agent context.

**Why:**
This is the core functionality of the v1.0.1 attachment feature. Without proper incoming attachment handling, agents cannot process images, documents, or media sent by users. This test ensures the `parseAttachments()` function correctly extracts file metadata from Bitrix24 webhook events.

**Prerequisites:**
- Bitrix24 bot is configured and running
- Webhook endpoint is accessible
- Image file (JPG/PNG) ready for testing

**Steps:**
1. Send an image to the bot via Bitrix24 chat
2. Monitor webhook logs for incoming request
3. Verify agent receives context with attachment data

**Expected Result:**
- Attachment object contains: `id`, `name`, `type`, `size`, `category="image"`, `url`
- Agent context includes `Bitrix24Attachments` array
- No errors in webhook processing logs

---

### TC-002: Receive Voice Message with Transcription
**Priority:** Critical

**Description:**
Verify that voice messages sent to the bot are transcribed using Whisper and the text is appended to the agent context.

**Why:**
Voice transcription enables hands-free interaction with the AI assistant. This test ensures the `transcribeVoiceAttachment()` function downloads the audio file and sends it to the speech transcription service.

**Prerequisites:**
- Bitrix24 bot configured
- OpenClaw speech service configured (Whisper model)
- Voice message recording capability on test device

**Steps:**
1. Record and send a voice message: "What is the weather today?"
2. Wait for webhook processing
3. Check agent context for transcription text

**Expected Result:**
- Voice attachment has `category="voice"`
- Attachment includes `transcription` field with text: "What is the weather today?"
- Agent receives message with transcription included
- `duration` field populated if available

---

### TC-003: Receive Multiple Attachments in Single Message
**Priority:** High

**Description:**
Verify that when a user sends multiple files (mix of images and documents) in one message, all attachments are parsed and included in the agent context.

**Why:**
Users often share multiple files (e.g., screenshots + documents). The plugin must handle arrays of attachments, not just single files. This tests the `parseAttachments()` loop and array handling.

**Prerequisites:**
- Multiple files ready (at least 2 images + 1 PDF)

**Steps:**
1. Send a message with 3 attachments simultaneously
2. Inspect webhook payload structure
3. Verify agent receives all 3 attachment records

**Expected Result:**
- `Attachments` array contains 3 items
- Each attachment has correct `category`: image for photos, document for PDF
- All files have valid `url` and `name` fields

---

### TC-004: Fetch File Info via disk.file.get API
**Priority:** High

**Description:**
Verify that `fetchFileInfo()` correctly calls Bitrix24's disk.file.get API to retrieve detailed file metadata (name, size, type, download URL).

**Why:**
Bitrix24 webhook events sometimes only include file IDs. The plugin must make an additional API call to get full metadata. This tests the API integration and error handling.

**Prerequisites:**
- Valid file ID from previous attachment
- Bot has permissions to access disk API

**Steps:**
1. Trigger webhook with attachment containing file ID only
2. Observe `fetchFileInfo()` API call
3. Verify returned metadata matches actual file

**Expected Result:**
- API call made to `disk.file.get` with correct file ID
- Returns: `ID`, `NAME`, `SIZE`, `TYPE`, `DOWNLOAD_URL`
- Attachment object populated with fetched metadata

---

### TC-005: Handle Attachment Categorization
**Priority:** Medium

**Description:**
Verify that files are correctly categorized based on MIME type and filename extension (image, voice, video, document, file).

**Why:**
Different attachment types require different handling (e.g., voice needs transcription, images may need vision analysis). The `categorizeAttachment()` function must be accurate.

**Steps:**
1. Send files with various types: .jpg, .png, .mp3, .mp4, .pdf, .docx
2. Check `category` field for each

**Expected Result:**
| File | Category |
|------|----------|
| photo.jpg | image |
| voice.mp3 | voice |
| video.mp4 | video |
| doc.pdf | document |
| data.zip | file |

---

## Test Suite: Outgoing Attachments

### TC-006: Send File from URL
**Priority:** Critical

**Description:**
Verify that `sendFileFromUrl()` sends a file to Bitrix24 user by providing just a URL (no upload to Bitrix24 disk needed).

**Why:**
This is the simplest and fastest way to send files. The agent can reference external URLs without uploading to Bitrix24 storage first.

**Prerequisites:**
- Publicly accessible file URL (e.g., image hosting)
- Valid Bitrix24 user ID

**Steps:**
```typescript
const result = await client.sendFileFromUrl({
  userId: "123",
  fileName: "report.pdf",
  fileUrl: "https://example.com/report.pdf",
  caption: "Here is your report"
});
```

**Expected Result:**
- API call to `imbot.message.add` with `ATTACH: [{ NAME, LINK }]`
- Message delivered to user with clickable file link
- Caption included in message

---

### TC-007: Send Multiple Files
**Priority:** High

**Description:**
Verify that `sendMultipleFiles()` sends multiple attachments in a single message.

**Why:**
Batch sending improves UX by avoiding message spam. This tests the upload loop and `ATTACH.MYFILES` array handling.

**Prerequisites:**
- 2+ files ready (mix of URLs and buffers)

**Steps:**
```typescript
await client.sendMultipleFiles({
  userId: "123",
  attachments: [
    { fileName: "doc1.pdf", fileType: "application/pdf", fileContent: buffer1 },
    { fileName: "doc2.pdf", fileType: "application/pdf", fileContent: url, isUrl: true }
  ],
  text: "Your documents"
});
```

**Expected Result:**
- All files uploaded to `disk.storage.uploadfile`
- `imbot.message.add` called with `ATTACH.MYFILES: [id1, id2]`
- User receives single message with all attachments

---

### TC-008: Upload Large File (>10MB)
**Priority:** Medium

**Description:**
Verify that large file uploads handle correctly or provide meaningful error messages.

**Why:**
Bitrix24 has file size limits. The plugin should handle timeout/size errors gracefully.

**Steps:**
1. Attempt to send 20MB file
2. Observe behavior

**Expected Result:**
- If successful: File uploaded and sent
- If failed: Clear error message about size limit
- No crash or undefined behavior

---

## Test Suite: Typing Indicator

### TC-009: Send Native Typing Indicator
**Priority:** High

**Description:**
Verify that `sendTyping()` correctly calls `imbot.chat.sendTyping` API and shows "Chat-bot is typing..." in Bitrix24 UI.

**Why:**
Real-time feedback improves UX by indicating the bot is processing. This was a v1.0.1 feature originally simulated but now uses native API.

**Prerequisites:**
- Updated plugin with real typing API (not simulated)
- Bitrix24 supports `imbot.chat.sendTyping` (verified via apidocs.bitrix24.com)

**Steps:**
```typescript
await client.sendTyping({
  userId: "123",
  duration: 60
});
```

**Expected Result:**
- API call to `imbot.chat.sendTyping` with `DIALOG_ID` and `BOT_ID`
- User sees "Chat-bot is typing a message..." in chat
- Returns `{ success: true }`

---

### TC-010: Typing Indicator with Invalid Bot ID
**Priority:** Medium

**Description:**
Verify graceful handling when bot ID is missing or invalid.

**Why:**
Error handling prevents crashes. The typing indicator should fail gracefully without breaking message flow.

**Steps:**
1. Call `sendTyping()` without `BOT_ID` configured
2. Observe error handling

**Expected Result:**
- Returns `{ success: false, error: "..." }`
- Logs warning about missing bot ID
- Does not throw unhandled exception

---

## Test Suite: Command Visibility

### TC-011: Register New Visible Command
**Priority:** Critical

**Description:**
Verify that `registerCommand({ hidden: false })` creates a command visible in the `/` menu.

**Why:**
Command visibility is core to v1.0.1. Users must see available commands.

**Prerequisites:**
- Valid command handler URL
- Command name and translations ready

**Steps:**
```typescript
await client.registerCommand({
  command: "help",
  lang: [
    { LANGUAGE_ID: "en", TITLE: "Show help information" },
    { LANGUAGE_ID: "de", TITLE: "Hilfe anzeigen" }
  ],
  hidden: false,  // <-- Key test parameter
  eventHandler: "https://..."
});
```

**Expected Result:**
- API call to `imbot.command.register` with `HIDDEN: "N"`
- Command appears in Bitrix24 `/` command menu
- Returns command ID

---

### TC-012: Update Hidden Command to Visible
**Priority:** Critical

**Description:**
Verify that `updateCommand()` can change an existing hidden command to visible.

**Why:**
One-time migration for existing bots. This was a key user request for v1.0.1.

**Prerequisites:**
- Existing command with `HIDDEN: "Y"`
- Valid `COMMAND_ID`

**Steps:**
```typescript
await client.updateCommand(commandId, { hidden: false });
```

**Expected Result:**
- API call to `imbot.command.update` with `HIDDEN: "N"`
- Command now visible in `/` menu
- Returns `true` on success

---

### TC-013: Bulk Update All Hidden Commands
**Priority:** High

**Description:**
Verify `showAllCommands()` bulk updates all hidden commands to visible.

**Why:**
Convenience method for one-time visibility updates. Tests the list + update loop pattern.

**Steps:**
1. Ensure multiple hidden commands exist
2. Call `showAllCommands()`

**Expected Result:**
- Calls `imbot.command.get` to list all commands
- Filters where `HIDDEN === "Y"`
- Updates each via `imbot.command.update`
- Returns `{ total, updated, alreadyVisible }` summary

---

### TC-014: List All Commands with Visibility Status
**Priority:** Medium

**Description:**
Verify `listCommands()` returns all commands with their visibility status.

**Why:**
Before updating, users need to see current state. This tests the read API.

**Steps:**
```typescript
const commands = await client.listCommands();
```

**Expected Result:**
- Returns array of command objects
- Each has `COMMAND_ID`, `COMMAND`, `HIDDEN`, `TITLE_EN`
- Correctly identifies which are hidden/visible

---

### TC-015: Command with Common Visibility (Global vs Local)
**Priority:** Medium

**Description:**
Verify the `COMMON` field works correctly for global vs local command visibility.

**Why:**
Global commands appear in all chats; local only in specific contexts. Part of command visibility enhancement.

**Steps:**
```typescript
await client.registerCommand({
  command: "globalcmd",
  lang: [...],
  common: true,  // Global
  hidden: false
});
```

**Expected Result:**
- API call with `COMMON: "Y"`
- Command appears in all chat contexts

---

## Test Suite: Error Handling & Edge Cases

### TC-016: Handle Malformed Webhook Payload
**Priority:** High

**Description:**
Verify webhook handler doesn't crash when receiving unexpected/malformed attachment data.

**Why:**
Bitrix24 webhooks can vary. The plugin must be resilient to missing fields.

**Steps:**
1. Send webhook with empty `ATTACH` field
2. Send webhook with missing `FILES` array
3. Send webhook with null attachment data

**Expected Result:**
- No crashes
- Returns empty attachments array or graceful skip
- Logs warning but continues processing

---

### TC-017: Voice Transcription Service Unavailable
**Priority:** Medium

**Description:**
Verify graceful handling when OpenClaw speech service is not configured.

**Why:**
Not all installations have Whisper configured. The plugin should still process the voice file URL without crashing.

**Steps:**
1. Disable speech service
2. Send voice message to bot

**Expected Result:**
- Voice attachment still received
- `transcription` field may be null
- No crash, message still processed
- Logs warning about unavailable speech service

---

### TC-018: API Rate Limiting
**Priority:** Medium

**Description:**
Verify that rapid consecutive API calls are rate-limited properly.

**Why:**
Bitrix24 has rate limits. The client has a `RateLimiter` class to prevent 429 errors.

**Steps:**
1. Send 5 messages rapidly
2. Observe timing between API calls

**Expected Result:**
- Minimum 1000ms between calls (configurable)
- No 429 Too Many Requests errors
- Smooth processing

---

## Test Suite: Integration Tests

### TC-019: End-to-End: User Sends Image → Agent Responds with File
**Priority:** Critical

**Description:**
Full integration test: User sends image → Agent receives it → Agent sends PDF back.

**Why:**
Tests both incoming and outgoing paths in one flow.

**Steps:**
1. User sends photo to bot
2. Agent processes with context
3. Agent calls `client.sendFileFromUrl()` to respond

**Expected Result:**
- Image received and parsed
- Agent sees attachment metadata
- Response file delivered to user

---

### TC-020: Command Registration on Bot Startup
**Priority:** High

**Description:**
Verify that when the gateway starts, it registers custom commands if configured.

**Why:**
Ensures `registerCommandsOnStartup` configuration option works.

**Prerequisites:**
- Config has `customCommands` array
- `registerCommandsOnStartup: true`

**Steps:**
1. Restart OpenClaw gateway
2. Check Bitrix24 command list

**Expected Result:**
- Commands registered automatically
- Visible in `/` menu after startup

---

## Summary

| Test Suite | Count | Coverage |
|------------|-------|----------|
| Incoming Attachments | 5 | Webhook parsing, categorization, transcription, file info |
| Outgoing Attachments | 3 | URL send, batch send, large files |
| Typing Indicator | 2 | Native API, error handling |
| Command Visibility | 5 | Register, update, bulk, list, global |
| Error Handling | 3 | Malformed data, service unavailable, rate limits |
| Integration | 2 | End-to-end flows |
| **Total** | **20** | Full v1.0.1 coverage |

---

## How to Run Tests

### Manual Testing
1. Set up Bitrix24 test bot
2. Configure environment variables
3. Run individual test cases
4. Check logs at `~/.openclaw/logs/`

### Automated Testing (Future)
```bash
# Future enhancement: add to package.json
npm test
# or
pnpm test:bitrix24
```

---

## Notes

- **Priority Critical** = Must pass before release
- **Priority High** = Should pass, features degraded if fails
- **Priority Medium** = Nice to have, graceful degradation acceptable
- All tests assume Bitrix24 API availability
- Some tests may require specific bot permissions (disk, imbot)
