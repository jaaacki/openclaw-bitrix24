# Bitrix24 Plugin v1.0.1 - PRD

## Overview
Enhance the Bitrix24 channel plugin with attachment support, typing indicators, and command visibility features.

## Implementation Status

### ✅ 1. Fix Attachment Support

#### 1.1 Incoming Attachments (Webhook → Agent) ✅ COMPLETE
**Implemented:**
- `parseAttachments()` function extracts metadata from webhook events
- Supports: images, documents, voice messages, video, files
- `fetchFileInfo()` gets detailed file metadata via `disk.file.get`
- Voice transcription via `transcribeVoiceAttachment()` using Whisper
- Attachments passed to agent context with URLs, type, size, name

**Files Modified:**
- `src/webhook.ts` - Added attachment parsing in `handleIncomingMessage()`
- `src/types.ts` - New attachment type definitions

#### 1.2 Outgoing Attachments (Agent → Bitrix24) ✅ COMPLETE
**Implemented:**
- `sendFileFromUrl()` - Send files directly from URL
- `sendMultipleFiles()` - Send multiple attachments in one message
- Enhanced MIME type handling
- URL-based attachments supported

**Files Modified:**
- `src/client.ts` - Added new file sending methods

### ⚠️ 2. Typing Indication (PARTIAL)
**Implemented:**
- `sendTyping()` method added to client (simulated - Bitrix24 has no native bot typing API)

**Updated:** Now uses native Bitrix24 API `imbot.chat.sendTyping` (thanks to apidocs.bitrix24.com reference). Shows "Chat-bot is typing a message..." indicator in dialogs.

### ✅ 3. Show Commands ✅ COMPLETE
**Implemented:**
- `registerCommand()` accepts `hidden?: boolean` parameter
- Set `hidden: false` to make commands visible in `/` menu
- `updateCommand()` allows changing visibility after registration
- `listCommands()` to view registered commands
- `COMMON` field support in updateCommand for global vs local commands

**Files Modified:**
- `src/client.ts` - Added bulk update methods and enhanced updateCommand

#### ✅ Bulk Update Existing Commands (DONE)
**Methods Implemented:**
- `showAllCommands()` - Updates all hidden commands to visible
- `bulkUpdateCommands(commandIds, fields)` - Bulk update multiple commands
- `getCommandDetails(commandId)` - Get specific command info

**Usage Example:**
```typescript
const client = new Bitrix24Client({ domain, webhookSecret, userId, botId, log });
const result = await client.showAllCommands();
console.log(`Updated ${result.updated} commands to visible`);
```

**Response from showAllCommands():**
```typescript
{
  total: number;           // Total commands found
  updated: number;         // Number changed from hidden to visible
  alreadyVisible: number;  // Number already visible
  commands: Array<{
    id: number;
    command: string;
    hidden: string;
    updated: boolean;
  }>;
}
```

**Bulk Update Example:**
```typescript
const result = await client.bulkUpdateCommands([1, 2, 3], {
  hidden: false,
  common: true,
  extranetSupport: true
});
console.log(`${result.successful} commands updated, ${result.failed} failed`);
```

## Implementation Notes

### File Structure
```
src/
  ├── webhook.ts     # Add attachment parsing
  ├── client.ts      # Bulk command updates, enhanced methods
  ├── channel.ts     # Add capabilities flags
  └── types.ts       # Define attachment interfaces
```

### Bitrix24 API References
- File upload: `disk.storage.uploadfile`
- File get: `disk.file.get`
- Message with attach: `imbot.message.add` with `ATTACH` param
- Commands: `imbot.command.register` / `imbot.command.unregister` / `imbot.command.update`

### Command Visibility API Details
- **imbot.command.get** - Lists all registered commands for the bot
- **imbot.command.update** - Updates command properties:
  - `HIDDEN`: 'Y' = hidden, 'N' = visible
  - `COMMON`: 'Y' = global commands, 'N' = local commands
  - `EXTRANET_SUPPORT`: 'Y' = available to extranet users
- Result fields returned: `ID`/`COMMAND_ID`, `COMMAND`, `HIDDEN`, `COMMON`, `LANG`

### Testing Checklist
- [x] Send image to agent (webhook receives, agent sees URL)
- [x] Send voice to agent (transcribes to text + provides audio URL)
- [x] Agent sends file from URL
- [x] Agent sends multiple attachments
- [x] Commands visible in Bitrix24 `/` menu (use `hidden: false`)
- [ ] Multiple attachments with mixed URLs and files (needs testing)
- [x] Bulk update hidden commands to visible
- [x] Check command details after update

## Version
1.0.1

## Created
2026-02-05
